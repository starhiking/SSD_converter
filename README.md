# SSD Conversation

This programe is convert the caffe model to tensorflow, which contains mobilenet and ssd.

## Models

If you just wanna to use one model file, download it directly.

1. caffe : MobileNetSSD_deploy_backbone.prototxt, mbv1_ssd_05_300_300_car_4_models3_iter_60000.caffemodel
2. tensorflow : ssd.pb/*
3. tflite : ssd.tflite


## Installion

If you need convert other model files, you need do the following steps.

1. Install [PyCaffe](https://blog.csdn.net/weixin_44138807/article/details/100666613) with Anaconda 
2. Install [Tensorflow](https://www.jianshu.com/p/b6f73bc80d4d) 1.14 version with Pypi
3. Install [MMdnn](https://github.com/microsoft/MMdnn) newest version with Pypi  

```pip install -U git+https://github.com/Microsoft/MMdnn.git@master```

Note : MMdnn must use 0.30 version and Tensorflow use 1.14 version

## Caffe -> Tensorflow

1. Delete layers : (permute, pirorBox ...). The details are between [ssd](Images/MobileNetSSD_deploy.prototxt.png) and [backbone](Images/MobileNetSSD_deploy_backbone.prototxt.png)

MobileNetSSD_deploy.prototxt -> MobileNetSSD_deploy_backbone.prototxt

2. run the following command : 
   
        mmconvert -sf caffe -in newssd_300_backbone.prototxt -iw mbv1_ssd_05_300_300_car_4_models3_iter_60000.caffemodel -df tensorflow -om ssd.pb

Note: the node names will be regenerated by operator indexs.

## Tensorflow -> TfLite

3. run the last command:

        tflite_convert --saved_model_dir=ssd.pb --output_format=TFLITE --output_file=./ssd.tflite --inference_type=FLOAT  --input_arrays=data --input_shapes=1,300,300,3  --output_arrays=add,add_1,add_2,add_3,add_4,add_5,add_6,add_7,add_8,add_9,add_10,add_11

Note: the indexs in details will resort by dict. eg. add, add_1, add_10, add_11, add_2...

## Result

We have used ```np.ones((300,300,3))*127``` as input for testing the last two conv layers (conv17_2_mbox_loc, conv17_2_mbox_conf).
The scripts of caffe, tflite and tensorflow are in the folder, and the results are in [result.log](result.log)


Remember the post processing need to be done in your codes.

## Tips

Tensorflow will product different names with caffe.
```saved_model_cli show --dir ssd.pb --all``` can get the names of input and ouputs.
Also tensorflow-cpu may have no SERVING tag, you can modify it to TRINING.

## License

In the end, fuck every licenses.